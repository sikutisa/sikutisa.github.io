---
tags: [system architecture, system design]
---

# 분산 시스템 설계를 위한 유일 ID 생성기 설계
## 가정
* ID는 유일해야 하고, 정렬 가능해야 함
    * 64비트로 표현 가능해야 함
* 나중에 생성된 ID는 이전 ID보다 항상 큰 값
    * 1만큼 클 필요는 없음
* ID는 숫자로만 구성
* 초당 10000개를 생성

## 분산 시스템에서 유일성이 보장되는 ID 생성 방법
### 다중 마스터 복제(multi-master replication)
* DB의 auto_increment 활용
    * 다만, 다음 ID를 구할 때 1이 아닌 DB 서버 개수인 k만큼 증가
* DB를 늘리면 초당 생성 가능 ID가 늘어나 규모 확장성 문제에 도움
* 단점
    * 여러 데이터 센터에 걸쳐 규모를 늘리기 어려움
    * ID의 유일성은 보장되나, 그 값이 시간 흐름에 맞춰 커지도록 보장할 수 없음
    * 서버 추가/삭제 시 제대로 동작하기 어려움

### UUID
* 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128비트짜리 수
    * 충돌 가능성이 극히 낮음
* 서버 간 조율 없이 독립적으로 생성 가능
    * 각 웹 서버에서 별도의 ID 생성기를 통해 독립적으로 ID 생성 가능
* 장점
    * UUID 생성의 단순함
        * 서버 간의 동기화 이슈도 없음
    * 각 서버가 알아서 생성하므로 규모 확장 용이
* 단점
    * 128비트로 그보다 작은 ID를 생성하는 요구 조건에 안 맞음
    * 시간순 정렬 불가
    * ID에 숫자가 아닌 값 포함될 수 있음

### 티켓 서버(ticket server)
* auto_increment 기능을 갖춘 DB 서버 하나만 중앙 집중형으로 사용하는 것
* 장점
    * 유일성이 보장되는, 숫자로만 구성된 ID 생성 가능
    * 구현이 쉽고, 중소 규모 애플리케이션에 적합
* 단점
    * 티켓 서버가 SPOF
        * 그렇다고 티켓 서버를 늘리면 동기화 이슈

### 트위터 스노플레이크(snowflake) 접근법
* 64비트인 ID의 구조를 여러 절(section)으로 분할
    * sign
        * 1 비트
        * 음수 양수 구별
    * timestamp
        * 41 비트
        * 기원 시각(epoch) 이후 몇 밀리초 경과했는지
    * datacenter ID
        * 5 비트
        * 32개의 데이터 센터 지원
    * server ID
        * 5 비트
        * 데이터센터 당 32개의 서버
    * serial number
        * 12비트
        * 각 서버에서는 ID를 생성할 때 마다 이 값을 1 증가
        * 1밀리초가 경과할 때마다 0으로 초기화

## 상세 설계
* 사전에 결정되는 값
    * 데이터센터 ID, 서버 ID
* 운영 중에 결정되는 값
    * 타임스탬프, 일련번호

### timestamp
* 시간 흐름에 따라 증가하므로 ID가 시간순으로 정렬될 때 활용
* 41비트로 대략 69년 정도의 시간을 지원
    * 이후에는 기원 시각을 변경하거나, ID 체계를 마이그레이션해야

### serial number
* 12비트이므로 4096개의 값
* 어떤 서버가 같은 밀리초 내에 1개 이상의 ID를 생성해야 0보다 큰 값이 됨

## 추가적으로 고려할 점
* 시계 동기화(clock synchronization)
    * 위 설계는 서버가 전부 같은 시계를 사용하는 가정이지만, 하나의 서버가 여러 코어에서 실행될 경우 유효하지 않을 수 있음
        * 여러 서버가 물리적으로 독립된 여러 장비에서 실행되는 경우도 마찬가지
    * NTP(Network Time Protocol)과 같은 개념 적용
* 각 section의 길이
    * 동시성(concurrency)이 낮고 수명이 긴 애플리케이션의 경우 일련번호를 줄이고 타임스탬프를 늘려야 할 수도 있음
* 고가용성(high availability)
    * ID 생성기는 필수 불가결(mission critical) 컴포넌트이므로 높은 가용성이 필수
